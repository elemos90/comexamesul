# üîÑ Sistema de Altera√ß√£o de Disponibilidade - v2.3.1

**Data**: 11/10/2025  
**Vers√£o**: 2.3.1  
**Status**: ‚úÖ Implementado

---

## üéØ Objetivo

Permitir que vigilantes alterem sua **disponibilidade geral** (dispon√≠vel ‚Üî indispon√≠vel) para aloca√ß√£o em j√∫ris, com **justificativa obrigat√≥ria** quando j√° estiverem alocados.

---

## üîÑ Diferen√ßa: Cancelamento vs Altera√ß√£o

### **Cancelamento de Candidatura**
- ‚ùå Cancela uma **candidatura espec√≠fica** a uma vaga
- Desvincula o vigilante daquela vaga/concurso
- Tipo: `cancelamento`

### **Altera√ß√£o de Disponibilidade** (NOVO)
- üîÑ Altera **status geral** de disponibilidade
- Afeta **todas** as aloca√ß√µes atuais e futuras
- Tipos: 
  - Dispon√≠vel ‚Üí Indispon√≠vel
  - Indispon√≠vel ‚Üí Dispon√≠vel
- Tipo: `alteracao`

---

## üîÑ Fluxos do Sistema

### **Cen√°rio 1: Vigilante N√ÉO Alocado**
```
Vigilante clica bot√£o para alterar status
  ‚Üì
Sistema verifica aloca√ß√µes
  ‚Üì
N√ÉO tem aloca√ß√£o ‚Üí Mudan√ßa IMEDIATA ‚úÖ
  ‚Üì
Status atualizado instantaneamente
```

### **Cen√°rio 2: Vigilante J√Å Alocado**
```
Vigilante clica bot√£o para alterar status
  ‚Üì
Sistema verifica aloca√ß√µes
  ‚Üì
TEM aloca√ß√£o ‚Üí Exige JUSTIFICATIVA
  ‚Üì
Formul√°rio com:
  - Lista de j√∫ris alocados
  - Justificativa (m√≠nimo 20 chars)
  - Upload opcional de documento
  ‚Üì
Solicita√ß√£o ‚Üí Status PENDENTE
  ‚Üì
Coordenador revisa e aprova/rejeita
```

---

## üé® Interface do Usu√°rio

### **Se√ß√£o "Disponibilidade Geral" (`/availability`)**

#### **Quando DISPON√çVEL:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Disponibilidade Geral              ‚îÇ
‚îÇ Status: [Dispon√≠vel ‚úì]             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îÇ
‚îÇ ‚îÇDispon√≠vel‚îÇ  ‚îÇIndispon√≠vel‚îÇ       ‚îÇ
‚îÇ ‚îÇ    ‚úì     ‚îÇ  ‚îÇ  (clique)  ‚îÇ       ‚îÇ
‚îÇ ‚îÇ [ATUAL]  ‚îÇ  ‚îÇ  [MUDAR]   ‚îÇ       ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### **Quando INDISPON√çVEL:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Disponibilidade Geral              ‚îÇ
‚îÇ Status: [Indispon√≠vel ‚úó]           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îÇ
‚îÇ ‚îÇDispon√≠vel‚îÇ  ‚îÇIndispon√≠vel‚îÇ       ‚îÇ
‚îÇ ‚îÇ (clique) ‚îÇ  ‚îÇ     ‚úó      ‚îÇ       ‚îÇ
‚îÇ ‚îÇ [MUDAR]  ‚îÇ  ‚îÇ  [ATUAL]   ‚îÇ       ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **Alerta de Solicita√ß√£o Pendente:**
Se houver solicita√ß√£o pendente, mostra aviso amarelo:
```
‚ö†Ô∏è Solicita√ß√£o de Altera√ß√£o Pendente
   Voc√™ tem uma solicita√ß√£o aguardando aprova√ß√£o
```

---

## üìÇ Arquivos Implementados

### **Controller:**
- ‚úÖ `app/Controllers/AvailabilityController.php`
  - `requestAvailabilityChange()` - Verificar e processar mudan√ßa
  - `submitAvailabilityChange()` - Enviar solicita√ß√£o com justificativa

### **View:**
- ‚úÖ `app/Views/availability/request_change.php` - Formul√°rio de justificativa
- ‚úÖ `app/Views/availability/index.php` - Se√ß√£o de controle adicionada

### **Rotas:**
```php
GET  /availability/change/{status}  // 0=indispon√≠vel, 1=dispon√≠vel
POST /availability/change/submit
```

---

## üõ†Ô∏è Funcionalidades Implementadas

### **1. Verifica√ß√£o Autom√°tica de Aloca√ß√£o**
```php
// Controller verifica se est√° alocado
$allocations = $juryVigilanteModel->getByVigilante($vigilanteId);

if (empty($allocations)) {
    // Mudan√ßa direta
    $userModel->updateUser($vigilanteId, [
        'available_for_vigilance' => $newStatus
    ]);
} else {
    // Exige justificativa
    return view('availability/request_change');
}
```

### **2. Toggle de Status Visual**
- ‚úÖ Cards clic√°veis com status atual destacado
- ‚úÖ Cores din√¢micas (verde/cinza)
- ‚úÖ √çcones indicativos

### **3. Formul√°rio de Justificativa**
**Elementos:**
- üìã Lista de j√∫ris alocados (visual destacado)
- ‚úçÔ∏è Justificativa obrigat√≥ria (m√≠nimo 20 caracteres)
- üìé Upload opcional de documento
- ‚ö†Ô∏è Avisos sobre impacto da mudan√ßa

### **4. Solicita√ß√µes Reutilizam Infraestrutura**
- Usa mesma tabela `availability_change_requests`
- Diferencia por campo `request_type`:
  - `'cancelamento'` - Cancelar candidatura
  - `'alteracao'` - Alterar disponibilidade

---

## üß™ Como Testar

### **Teste 1: Mudan√ßa Direta (Sem Aloca√ß√£o)**
1. Login como vigilante
2. **N√ÉO esteja** alocado a nenhum j√∫ri
3. V√° em **Disponibilidade** (`/availability`)
4. Veja se√ß√£o "Disponibilidade Geral"
5. Clique no card oposto ao status atual
6. ‚úÖ Deve mudar instantaneamente
7. ‚úÖ Mensagem: "Disponibilidade atualizada"

**Exemplo:**
- Status atual: Indispon√≠vel
- Clica em "Dispon√≠vel"
- ‚úÖ Muda para dispon√≠vel imediatamente

### **Teste 2: Mudan√ßa com Justificativa (Com Aloca√ß√£o)**
1. Login como vigilante
2. **SEJA alocado** a 1+ j√∫ris
3. V√° em **Disponibilidade**
4. Clique no card oposto ao status atual
5. ‚úÖ Deve abrir formul√°rio de justificativa
6. ‚úÖ Deve mostrar lista de j√∫ris alocados
7. Preencha justificativa (20+ caracteres)
8. (Opcional) Anexe documento
9. Envie solicita√ß√£o
10. ‚úÖ Mensagem: "Solicita√ß√£o enviada"
11. ‚úÖ Alerta amarelo aparece na p√°gina

### **Teste 3: Solicita√ß√£o Pendente**
1. Com solicita√ß√£o pendente existente
2. Recarregue p√°gina de disponibilidade
3. ‚úÖ Deve mostrar alerta amarelo no topo
4. ‚úÖ Bot√£o de mudan√ßa ainda dispon√≠vel (pode criar nova)

### **Teste 4: Dispon√≠vel ‚Üí Indispon√≠vel (Com Aloca√ß√£o)**
1. Vigilante DISPON√çVEL e ALOCADO
2. Clica "Indispon√≠vel"
3. ‚úÖ Formul√°rio cor vermelha
4. ‚úÖ Aviso: "Voc√™ ser√° desalocado dos j√∫ris"
5. Envia justificativa
6. ‚úÖ Solicita√ß√£o criada

### **Teste 5: Indispon√≠vel ‚Üí Dispon√≠vel (Com Aloca√ß√£o)**
1. Vigilante INDISPON√çVEL mas (teoricamente) ALOCADO
2. Clica "Dispon√≠vel"
3. ‚úÖ Formul√°rio cor verde
4. Envia justificativa
5. ‚úÖ Solicita√ß√£o criada

---

## üìä Dados Armazenados

### **Tabela: `availability_change_requests`**
```sql
INSERT INTO availability_change_requests (
    vigilante_id,
    application_id,          -- Candidatura aprovada do vigilante
    request_type,            -- 'alteracao'
    reason,                  -- Justificativa
    attachment_path,         -- Documento (se anexado)
    has_allocation,          -- 1 se alocado, 0 se n√£o
    jury_details,            -- JSON: {new_status, juries:[...]}
    status,                  -- 'pendente'
    ...
);
```

**Exemplo de `jury_details`:**
```json
{
  "new_status": 0,
  "juries": [
    {
      "jury_id": 5,
      "subject": "Matem√°tica",
      "exam_date": "2025-01-15",
      "location": "Campus A",
      "room": "101"
    }
  ]
}
```

---

## üîê Valida√ß√µes

### **Backend:**
1. ‚úÖ Apenas vigilante logado
2. ‚úÖ Verifica aloca√ß√µes automaticamente
3. ‚úÖ Justificativa obrigat√≥ria se alocado (m√≠nimo 20 chars)
4. ‚úÖ Valida√ß√£o de arquivo (tipo e tamanho)
5. ‚úÖ Requer candidatura aprovada para vincular

### **Frontend:**
6. ‚úÖ Toggle visual do status atual
7. ‚úÖ Alerta de solicita√ß√£o pendente
8. ‚úÖ Mensagens claras de sucesso/erro
9. ‚úÖ Upload drag & drop

---

## üéØ Diferen√ßas de Comportamento

| Situa√ß√£o | Cancelamento | Altera√ß√£o Disponibilidade |
|----------|--------------|---------------------------|
| **O que altera** | Candidatura espec√≠fica | Status geral |
| **Afeta** | 1 vaga | Todas aloca√ß√µes |
| **Quando exige justificativa** | Se alocado | Se alocado |
| **Campo `request_type`** | `'cancelamento'` | `'alteracao'` |
| **Campo `jury_details`** | Array de j√∫ris | `{new_status, juries}` |
| **Bot√£o na interface** | "Cancelar" (candidatura) | Cards de status |

---

## üìã Logs de Atividade

### **Mudan√ßa Direta:**
```sql
SELECT * FROM activity_log 
WHERE entity = 'users' 
  AND action = 'update_availability'
  AND JSON_EXTRACT(metadata, '$.direct') = true;
```

### **Solicita√ß√£o de Mudan√ßa:**
```sql
SELECT * FROM activity_log 
WHERE entity = 'availability_change_requests' 
  AND action = 'create_change';
```

---

## üöß Pr√≥ximas Implementa√ß√µes (v2.4)

### **Interface de Revis√£o (Coordenador)**
- [ ] Listar solicita√ß√µes pendentes (cancelamento + altera√ß√£o)
- [ ] Ver detalhes:
  - Tipo: cancelamento ou altera√ß√£o
  - Novo status (se altera√ß√£o)
  - J√∫ris afetados
  - Justificativa e documento
- [ ] Aprovar/rejeitar solicita√ß√µes
- [ ] Ao aprovar altera√ß√£o de disponibilidade:
  - Atualizar campo `available_for_vigilance`
  - Se mudou para indispon√≠vel: desalocar dos j√∫ris
  - Notificar vigilante

### **Notifica√ß√µes**
- [ ] Email ao vigilante (solicita√ß√£o enviada)
- [ ] Email ao coordenador (nova solicita√ß√£o)
- [ ] Email ao vigilante (aprovada/rejeitada)
- [ ] Indicar novo status ap√≥s aprova√ß√£o

### **Dashboard**
- [ ] Estat√≠sticas de solicita√ß√µes
- [ ] Gr√°fico: cancelamentos vs altera√ß√µes
- [ ] Motivos mais comuns

---

## ‚úÖ Checklist de Implementa√ß√£o

### **Backend:**
- [x] M√©todo `requestAvailabilityChange()`
- [x] M√©todo `submitAvailabilityChange()`
- [x] Verifica√ß√£o autom√°tica de aloca√ß√£o
- [x] Mudan√ßa direta (sem aloca√ß√£o)
- [x] Reutiliza√ß√£o da tabela existente
- [x] Upload de documentos
- [x] Valida√ß√µes completas

### **Frontend:**
- [x] Se√ß√£o "Disponibilidade Geral"
- [x] Cards clic√°veis de status
- [x] Alerta de solicita√ß√£o pendente
- [x] Formul√°rio `request_change.php`
- [x] Cores din√¢micas (verde/vermelho)
- [x] Upload drag & drop

### **Rotas:**
- [x] GET `/availability/change/{status}`
- [x] POST `/availability/change/submit`

### **Pendente (v2.4):**
- [ ] Interface de revis√£o (coordenador)
- [ ] Aprova√ß√£o de altera√ß√µes
- [ ] Desaloca√ß√£o autom√°tica
- [ ] Notifica√ß√µes

---

## üéâ Status Final

**Implementa√ß√£o**: ‚úÖ **Conclu√≠da (100% Vigilante)**

### **Funcional:**
- ‚úÖ Vigilante pode alterar disponibilidade
- ‚úÖ Sistema detecta aloca√ß√£o automaticamente
- ‚úÖ Mudan√ßa direta se n√£o alocado
- ‚úÖ Justificativa obrigat√≥ria se alocado
- ‚úÖ Upload de documentos
- ‚úÖ Interface intuitiva
- ‚úÖ Logs de auditoria

### **Pr√≥xima Fase:**
- ‚è≥ Interface de revis√£o para coordenadores
- ‚è≥ Fluxo de aprova√ß√£o/rejei√ß√£o
- ‚è≥ Atualiza√ß√£o autom√°tica de status
- ‚è≥ Desaloca√ß√£o autom√°tica

---

## üì∏ Casos de Uso Completos

### **Caso 1: Vigilante Quer Ficar Indispon√≠vel (Sem J√∫ris)**
**Situa√ß√£o:** Jo√£o est√° dispon√≠vel mas n√£o foi alocado ainda.
**A√ß√£o:**
1. Jo√£o clica em "Indispon√≠vel"
2. ‚úÖ Sistema muda status instantaneamente
3. ‚úÖ Jo√£o n√£o aparece mais para novos j√∫ris

### **Caso 2: Vigilante Quer Ficar Indispon√≠vel (Com J√∫ris)**
**Situa√ß√£o:** Maria est√° dispon√≠vel e alocada em 3 j√∫ris.
**A√ß√£o:**
1. Maria clica em "Indispon√≠vel"
2. ‚úÖ Sistema mostra os 3 j√∫ris
3. Maria escreve: "Cirurgia marcada para essa semana"
4. Maria anexa atestado m√©dico
5. ‚úÖ Solicita√ß√£o criada (status pendente)
6. Coordenador aprova
7. ‚úÖ Maria desalocada dos 3 j√∫ris
8. ‚úÖ Status muda para indispon√≠vel

### **Caso 3: Vigilante Quer Voltar a Ficar Dispon√≠vel**
**Situa√ß√£o:** Pedro est√° indispon√≠vel h√° 2 meses.
**A√ß√£o:**
1. Pedro clica em "Dispon√≠vel"
2. Se n√£o tem j√∫ris ‚Üí mudan√ßa imediata
3. Se tem j√∫ris (raro) ‚Üí justificativa
4. ‚úÖ Pedro volta a aparecer para aloca√ß√µes futuras

---

**üöÄ Sistema completo e funcional para vigilantes!**

Vigilantes agora t√™m controle total sobre sua disponibilidade, com processo transparente e justificado.
